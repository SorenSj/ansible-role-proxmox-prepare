---
- name: Prepare proxmox
  hosts: all
  gather_facts: false
  tasks:
    - name: Init
      ansible.builtin.include_tasks:
        file: init.yml

    - name: Backup etc
      ansible.builtin.include_tasks:
        file: backup_etc.yml

    - name: Date timezone
      ansible.builtin.include_tasks:
        file: date_timezone.yml

    - name: Prepare repos
      ansible.builtin.include_tasks:
        file: prepare_repos.yml

    - name: Install software
      ansible.builtin.include_tasks:
        file: install_software.yml

    - name: Run role for init sshd user
      ansible.builtin.include_tasks:
        file: init_sshd_user.yml

    - name: Ð¡onfigure-users
      ansible.builtin.include_tasks:
        file: configure_users.yml

    - name: Configure-bash
      ansible.builtin.include_tasks:
        file: configure_bash.yml

    - name: Prepare system
      ansible.builtin.include_tasks:
        file: prepare_system.yml

    - name: Configure-network
      ansible.builtin.include_tasks:
        file: configure_network.yml

    - name: Configure-zfs
      ansible.builtin.include_tasks:
        file: configure_zfs.yml

    - name: Configure-proxmox
      ansible.builtin.include_tasks:
        file: configure_proxmox.yml

    - name: Enable pcie-passthrough
      ansible.builtin.include_tasks:
        file: pcie_passthrough.yml

    - name: Configure ksmtuned
      ansible.builtin.include_tasks:
        file: ksmtuned.yml

    - name: Ram disk
      ansible.builtin.include_tasks:
        file: create_ramdisk.yml

    - name: Set cpu performance
      ansible.builtin.include_tasks:
        file: cpu_performance.yml

    - name: Web show temperatures
      ansible.builtin.include_tasks:
        file: web_temp_sensors.yml

    - name: Kernel pinning
      ansible.builtin.include_tasks:
        file: pin_kernel.yml

    - name: Fail2ban
      ansible.builtin.include_tasks:
        file: fail2ban.yml

    - name: Nested virtualization
      ansible.builtin.include_tasks:
        file: nested_virtualization.yml

    - name: Enable nginx
      ansible.builtin.include_tasks:
        file: nginx.yml

    - name: Move logs to tmpfs
      ansible.builtin.include_tasks:
        file: logs_tmpfs.yml

    - name: Update system
      ansible.builtin.include_tasks:
        file: update_reboot.yml

  handlers:
    - name: Update GRUB
      ansible.builtin.command: update-grub
      changed_when: false
